{"version":3,"file":"esc-influxdb.js","sources":["../src/index.js"],"sourcesContent":["import SystemESC from '@mark48evo/system-esc';\nimport { InfluxDB, FieldType } from 'influx';\nimport amqplib from 'amqplib';\nimport Debug from 'debug';\n\nconst debug = Debug('esc:influxdb');\n\nconst config = {\n  influxHost: process.env.INFLUXDB_HOST || 'localhost',\n  influxDB: process.env.INFLUXDB_DB || 'mark48evo',\n  host: process.env.RABBITMQ_HOST || 'amqp://localhost',\n};\n\nconst influx = new InfluxDB({\n  host: config.influxHost,\n  database: config.influxDB,\n  schema: [\n    {\n      measurement: 'esc',\n      fields: {\n        tempMOSFET: FieldType.FLOAT,\n        tempMOTOR: FieldType.FLOAT,\n        currentBATTERY: FieldType.FLOAT,\n        currentMOTOR: FieldType.FLOAT,\n        id: FieldType.FLOAT,\n        iq: FieldType.FLOAT,\n        duty: FieldType.FLOAT,\n        rpm: FieldType.FLOAT,\n        voltage: FieldType.FLOAT,\n        ampHoursConsumed: FieldType.FLOAT,\n        ampHoursCharged: FieldType.FLOAT,\n        wattHoursConsumed: FieldType.FLOAT,\n        wattHoursCharged: FieldType.FLOAT,\n        tachometerValue: FieldType.FLOAT,\n        tachometerABS: FieldType.FLOAT,\n      },\n      tags: [\n        'device',\n        'faultCode',\n      ],\n    },\n  ],\n});\n\nasync function main() {\n  await influx.getDatabaseNames()\n    .then(async (names) => {\n      if (!names.includes(config.influxDB)) {\n        debug(`Creating InfluxDB \"${config.influxDB}\" database`);\n\n        await influx.createDatabase(config.influxDB);\n\n        return Promise.resolve();\n      }\n\n      return Promise.resolve();\n    });\n\n  const connect = await amqplib.connect(config.host);\n  const channel = await connect.createChannel();\n\n  const systemESC = await SystemESC(channel);\n\n  systemESC.on('stats', (data) => {\n    const fields = {\n      tempMOSFET: data.temp.mosfet,\n      tempMOTOR: data.temp.motor,\n      currentBATTERY: data.current.battery,\n      currentMOTOR: data.current.motor,\n      id: data.id,\n      iq: data.iq,\n      duty: data.dutyNow,\n      rpm: data.rpm,\n      voltage: data.voltage,\n      ampHoursConsumed: data.ampHours.consumed,\n      ampHoursCharged: data.ampHours.charged,\n      wattHoursConsumed: data.wattHours.consumed,\n      wattHoursCharged: data.wattHours.charged,\n      tachometerValue: data.tachometer.value,\n      tachometerABS: data.tachometer.abs,\n    };\n\n    const tags = {\n      device: 'left',\n      faultCode: data.faultCode,\n    };\n\n    influx.writePoints([\n      {\n        measurement: 'esc',\n        tags,\n        fields,\n        timestamp: new Date(data.timestamp),\n      },\n    ]).catch((err) => {\n      console.error(`InfluxDB Error: \"${err.message()}\" \"${err.stack}\"`);\n    });\n  });\n}\n\nmain();\n"],"names":["debug","Debug","config","process","env","INFLUXDB_HOST","INFLUXDB_DB","RABBITMQ_HOST","influx","InfluxDB","influxHost","influxDB","FieldType","FLOAT","main","getDatabaseNames","then","names","includes","createDatabase","Promise","resolve","connect","amqplib","host","channel","createChannel","systemESC","SystemESC","on","data","fields","temp","mosfet","motor","current","battery","id","iq","dutyNow","rpm","voltage","ampHours","consumed","charged","wattHours","tachometer","value","abs","tags","faultCode","writePoints","Date","timestamp","catch","err","error","message","stack"],"mappings":";;;;;;;;;AAKA,MAAMA,QAAQC,MAAM,cAAN,CAAd;AAEA,MAAMC,SAAS;cACDC,QAAQC,GAAR,CAAYC,aAAZ,IAA6B,WAD5B;YAEHF,QAAQC,GAAR,CAAYE,WAAZ,IAA2B,WAFxB;QAGPH,QAAQC,GAAR,CAAYG,aAAZ,IAA6B;CAHrC;AAMA,MAAMC,WAAS,IAAIC,eAAJ,CAAa;QACpBP,OAAOQ,UADa;YAEhBR,OAAOS,QAFS;UAGlB,CACN;iBACe,KADf;YAEU;kBACMC,iBAAUC,KADhB;iBAEKD,iBAAUC,KAFf;sBAGUD,iBAAUC,KAHpB;oBAIQD,iBAAUC,KAJlB;UAKFD,iBAAUC,KALR;UAMFD,iBAAUC,KANR;YAOAD,iBAAUC,KAPV;WAQDD,iBAAUC,KART;eASGD,iBAAUC,KATb;wBAUYD,iBAAUC,KAVtB;uBAWWD,iBAAUC,KAXrB;yBAYaD,iBAAUC,KAZvB;wBAaYD,iBAAUC,KAbtB;uBAcWD,iBAAUC,KAdrB;qBAeSD,iBAAUC;KAjB7B;UAmBQ,CACJ,QADI,EAEJ,WAFI;GApBF;CAHK,CAAf;;AA+BA,eAAeC,IAAf,GAAsB;QACdN,SAAOO,gBAAP,GACHC,IADG,CACE,MAAOC,KAAP,IAAiB;QACjB,CAACA,MAAMC,QAAN,CAAehB,OAAOS,QAAtB,CAAL,EAAsC;YAC7B,sBAAqBT,OAAOS,QAAS,YAA5C;YAEMH,SAAOW,cAAP,CAAsBjB,OAAOS,QAA7B,CAAN;aAEOS,QAAQC,OAAR,EAAP;;;WAGKD,QAAQC,OAAR,EAAP;GAVE,CAAN;QAaMC,UAAU,MAAMC,QAAQD,OAAR,CAAgBpB,OAAOsB,IAAvB,CAAtB;QACMC,UAAU,MAAMH,QAAQI,aAAR,EAAtB;QAEMC,YAAY,MAAMC,UAAUH,OAAV,CAAxB;YAEUI,EAAV,CAAa,OAAb,EAAuBC,IAAD,IAAU;UACxBC,SAAS;kBACDD,KAAKE,IAAL,CAAUC,MADT;iBAEFH,KAAKE,IAAL,CAAUE,KAFR;sBAGGJ,KAAKK,OAAL,CAAaC,OAHhB;oBAICN,KAAKK,OAAL,CAAaD,KAJd;UAKTJ,KAAKO,EALI;UAMTP,KAAKQ,EANI;YAOPR,KAAKS,OAPE;WAQRT,KAAKU,GARG;eASJV,KAAKW,OATD;wBAUKX,KAAKY,QAAL,CAAcC,QAVnB;uBAWIb,KAAKY,QAAL,CAAcE,OAXlB;yBAYMd,KAAKe,SAAL,CAAeF,QAZrB;wBAaKb,KAAKe,SAAL,CAAeD,OAbpB;uBAcId,KAAKgB,UAAL,CAAgBC,KAdpB;qBAeEjB,KAAKgB,UAAL,CAAgBE;KAfjC;UAkBMC,OAAO;cACH,MADG;iBAEAnB,KAAKoB;KAFlB;aAKOC,WAAP,CAAmB,CACjB;mBACe,KADf;UAAA;YAAA;iBAIa,IAAIC,IAAJ,CAAStB,KAAKuB,SAAd;KALI,CAAnB,EAOGC,KAPH,CAOUC,GAAD,IAAS;cACRC,KAAR,CAAe,oBAAmBD,IAAIE,OAAJ,EAAc,MAAKF,IAAIG,KAAM,GAA/D;KARF;GAxBF;;;AAqCF5C"}